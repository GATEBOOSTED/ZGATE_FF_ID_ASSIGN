sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/ui/core/Fragment","sap/ui/table/Row","sap/m/MessageBox","sap/m/MessageToast","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/core/ValueState","sap/m/Dialog","sap/m/DialogType","sap/m/Button","sap/m/ButtonType","sap/m/Text","sap/ui/model/FilterType","../model/formatter"],function(e,t,i,s,a,o,n,r,l,d,g,h,c,u,f,b){"use strict";return e.extend("GATE.ZGATE_FF_ASS.controller.Main",{formatter:b,onInit:function(){this.dateFormatYYYYMMDD=sap.ui.core.format.DateFormat.getDateInstance({pattern:"yyyyMMdd"});this.dateFormatDDMMYYYY=sap.ui.core.format.DateFormat.getDateInstance({pattern:"dd/MM/yyyy"});var e=new Date;var i=new t({System:"",IconTabSelectedKey:"1",ReferenceTicket:"",ValDateFrom:this.dateFormatDDMMYYYY.format(e),ValDateTo:"",RequestName:"",MsgQuickView:"",ReasonCode:"",ReasonCodeButtonVisible:false,isFFIT:false,Comments:"",AttachmentTitle:"",AttachmentType:"F",AttachmentLink:"",AttachmentFileData:""});this.getView().setModel(i,"GlobalData")},handleRefresh:function(e){var t=this;a.confirm(this.getView().getModel("i18n").getResourceBundle().getText("MsgConfirmRefresh"),{actions:[a.Action.YES,a.Action.CANCEL],emphasizedAction:a.Action.YES,onClose:function(e){if(e==="YES"){location.reload()}}})},onAfterSystemSelection:function(){if(this.getView().getModel("GlobalData").getData().System!==""){this.getOwnerComponent().getModel().callFunction("/CHECK_SYSTEM_CON",{method:"GET",urlParameters:{Systems:this.getView().byId("sGlobalSystem").getSelectedKey()},success:function(e){if(e.Type==="E"){this.getView().setBusy(false);this.getView().byId("sGlobalSystem").focus();this.getView().byId("sGlobalSystem").setValueState("Error");this.getView().byId("bSubmitRequest").setVisible(false);a.error(e.Message)}else{this.getView().byId("sGlobalSystem").setValueState("None");this.getView().byId("sGlobalSystem").setEnabled(false);this.getView().byId("bSubmitRequest").setVisible(true)}}.bind(this),error:function(e){this.getView().setBusy(false);o.show(e.message+" ("+e.statusText+")")}.bind(this)})}else{this.getView().byId("sGlobalSystem").setEnabled(true)}},FillReasonCodeList:function(){var e=this.getView().getModel("SelectedFfIdModel");if(e!==undefined){var t=this.getView().byId("sReasonCode");var i=t.getBinding("items");var s=[];for(var a=0;a<e.getData().length;a++){s.push(new n("Connector",r.EQ,e.getData()[a].Connector))}i.filter(s,f.Application)}},checkMandatoryFields:function(){var e="";if(this.getView().getModel("GlobalData").getData().System===""){e="X";this.getView().getModel("GlobalData").setProperty("/IconTabSelectedKey","1");var t=this;a.error(this.getView().getModel("i18n").getResourceBundle().getText("MsgErrorEmptySystem"),{actions:[a.Action.OK],emphasizedAction:a.Action.OK,onClose:function(e){t.getView().byId("sGlobalSystem").setValueState("Error");t.getView().byId("sGlobalSystem").focus()}})}return e},handleTabBarSelect:function(){this.checkMandatoryFields()},onExit:function(){if(this._oDialog_AddUsers){this._oDialog_AddUsers.destroy();this.getView().setBusy(false)}},getSelectedRowContext:function(e,t){var i=this.getView().byId(e);var s=i.getSelectedIndex();if(s===-1){o.show(this.getView().getModel("i18n").getResourceBundle().getText("MsgSelectRow"));return}var a=i.getContextByIndex(s);if(a&&t){t.call(this,a,s,i)}return a},onAddAddUsersDialog:function(){var e=this.checkMandatoryFields();if(e===""){this.AvailableUsersModel=null;this.getView().setModel(this.AvailableUsersModel,"AvailableUsersModel");this._oDialog_AddUsers=sap.ui.xmlfragment(this.getView().getId(),"GATE.ZGATE_FF_ASS.view.fragment.AddUsers",this);this.getView().addDependent(this._oDialog_AddUsers);this._oDialog_AddUsers.open()}},onDeleteUser:function(e){var i=e.getSource().getParent().getBindingContextPath();var s=this.getView().getModel("SelectedUsersModel").getObject(i);for(var a in this.tab_SelectedUsers){if(s.UserId===this.tab_SelectedUsers[a].UserId){this.tab_SelectedUsers.splice(a,1)}}this.initRiskCheckTab();this.SelectedUsersModel=new t(this.tab_SelectedUsers);this.getView().setModel(this.SelectedUsersModel,"SelectedUsersModel")},onSearchUsers:function(e){sap.ui.core.BusyIndicator.show();var i=new Array;var s=new n({path:"Connector",operator:r.EQ,value1:this.getView().getModel("GlobalData").getData().System});i.push(s);var a=new n({path:"FieldValue",operator:r.EQ,value1:this.getView().byId("iFieldValue").getValue()});i.push(a);var l=new n({path:"FieldName",operator:r.EQ,value1:this.getView().byId("sSearchBy").getSelectedKey()});i.push(l);this.getOwnerComponent().getModel().read("/UsersSet",{filters:i,success:function(e){this.AvailableUsersModel=new t(e);this.getView().setModel(this.AvailableUsersModel,"AvailableUsersModel");sap.ui.core.BusyIndicator.hide()}.bind(this),error:function(e){o.show(e.message+" ("+e.statusText+")");sap.ui.core.BusyIndicator.hide()}.bind(this)})},onCloseAddUsersDialog:function(){if(this._oDialog_AddUsers){this._oDialog_AddUsers.destroy();this.getView().setBusy(false)}},OnSubmitAddUsersDialog:function(){if(this.tab_SelectedUsers===undefined){this.tab_SelectedUsers=[]}var e=this.getView().getModel("AvailableUsersModel");if(e!==undefined){var i;for(var s=0;s<this.AvailableUsersModel.oData.results.length;s++){if(this.AvailableUsersModel.oData.results[s].Rank){i=false;if(this.tab_SelectedUsers.length!==0){for(var a=0;a<this.tab_SelectedUsers.length;a++){if(this.AvailableUsersModel.oData.results[s].UserId===this.tab_SelectedUsers[a].UserId){i=true}}}if(i===false){this.tab_SelectedUsers.push(this.AvailableUsersModel.oData.results[s])}}}this.initRiskCheckTab();this.SelectedUsersModel=new t(this.tab_SelectedUsers);this.getView().setModel(this.SelectedUsersModel,"SelectedUsersModel")}this._oDialog_AddUsers.destroy();this.getView().setBusy(false)},UserConfig:{initialRank:0,defaultRank:1024,rankAlgorithm:{Before:function(e){return e+1024},Between:function(e,t){return(e+t)/2},After:function(e){return e/2}}},onUserDragStart:function(e){var t=e.getParameter("target");var i=e.getParameter("dragSession");i.setComplexData("draggedRowContext",t.getBindingContext("AvailableUsersModel"))},onUserDropTable1:function(e){var t=e.getParameter("dragSession");var i=t.getComplexData("draggedRowContext");if(!i){return}this.AvailableUsersModel.setProperty("Rank",this.UserConfig.initialRank,i);this.AvailableUsersModel.refresh(true)},UserMoveToTable1:function(){var e=this.getView().byId("UserTable2");var t=e.getSelectedIndices();if(t.length==0){o.show(this.getView().getModel("i18n").getResourceBundle().getText("MsgSelectARow"));return}else if(t.length==1){this.getSelectedRowContext("UserTable2",function(e,t,i){this.AvailableUsersModel.setProperty("Rank",this.UserConfig.initialRank,e);this.AvailableUsersModel.refresh(true);var s=i.getContextByIndex(t+1);if(!s){i.setSelectedIndex(t-1)}})}else if(t.length>1){var i,s,a;for(var n=t.length;n>=0;n--){s=t[n];this.AvailableUsersModel.setProperty("Rank",this.UserConfig.initialRank,e.getContextByIndex(t[n]));this.AvailableUsersModel.refresh(true)}}this.getView().byId("UserTable1").clearSelection();this.getView().byId("UserTable2").clearSelection()},onUserDropTable2:function(e){var t=e.getParameter("dragSession");var i=t.getComplexData("draggedRowContext");if(!i){return}var a=this.UserConfig;var o=a.defaultRank;var n=e.getParameter("droppedControl");if(n&&n instanceof s){var r=e.getParameter("dropPosition");var l=n.getBindingContext("AvailableUsersModel");var d=l.getProperty("Rank");var g=n.getIndex();var h=n.getParent();var c=g+(r==="After"?1:-1);var u=h.getContextByIndex(c);if(!u){o=a.rankAlgorithm[r](d)}else{o=a.rankAlgorithm.Between(d,u.getProperty("Rank"))}}this.AvailableUsersModel.setProperty("Rank",o,i);this.AvailableUsersModel.refresh(true)},UserMoveToTable2:function(){var e=this.getView().byId("UserTable1");var t=this.getView().byId("UserTable2");var i=e.getSelectedIndices();var s=this.UserConfig.defaultRank;var a=t.getContextByIndex(0);if(i.length==0){o.show(this.getView().getModel("i18n").getResourceBundle().getText("MsgSelectARow"));return}else if(i.length==1){this.getSelectedRowContext("UserTable1",function(e){if(a){s=this.UserConfig.rankAlgorithm.Before(a.getProperty("Rank"))}this.AvailableUsersModel.setProperty("Rank",s,e);this.AvailableUsersModel.refresh(true)})}else if(i.length>1){var n;for(var r=i.length;r>=0;r--){n=e.getContextByIndex(i[r]);a=t.getContextByIndex(0);if(a){s=this.UserConfig.rankAlgorithm.Before(a.getProperty("Rank"))}this.AvailableUsersModel.setProperty("Rank",s,n);this.AvailableUsersModel.refresh(true)}}this.getView().byId("UserTable1").clearSelection();this.getView().byId("UserTable2").clearSelection()},onAddFfIdToAssignDialog:function(){var e=this.checkMandatoryFields();if(e===""){this.AvailableFfIdModel=null;this.getView().setModel(this.AvailableFfIdModel,"AvailableFfIdModel");this._oDialog_AddFfId=sap.ui.xmlfragment(this.getView().getId(),"GATE.ZGATE_FF_ASS.view.fragment.AddFfId",this);this.getView().addDependent(this._oDialog_AddFfId);this._oDialog_AddFfId.open()}},onDeleteFfId:function(e){var i=e.getSource().getParent().getBindingContextPath();var s=this.getView().getModel("SelectedFfIdModel").getObject(i);for(var a in this.tab_SelectedFfId){if(s.AppType===this.tab_SelectedFfId[a].AppType&&s.Ffobject===this.tab_SelectedFfId[a].Ffobject&&s.Connector===this.tab_SelectedFfId[a].Connector){this.tab_SelectedFfId.splice(a,1)}}this.initRiskCheckTab();this.FillReasonCodeList();this.SelectedFfIdModel=new t(this.tab_SelectedFfId);this.getView().setModel(this.SelectedFfIdModel,"SelectedFfIdModel")},onDisplayDetailFfIdDialog:function(e){sap.ui.core.BusyIndicator.show();var i=e.getSource().getParent().getBindingContextPath();var s=this.getView().getModel("SelectedFfIdModel").getObject(i);var a=new Array;var l=new n({path:"Connector",operator:r.EQ,value1:s.Connector});a.push(l);var d=new n({path:"UserId",operator:r.EQ,value1:s.Ffobject});a.push(d);this.getOwnerComponent().getModel().read("/FirefighterIdDetailSet",{filters:a,success:function(e){this.FirefighterIdDetailModel=new t(e);this.getView().setModel(this.FirefighterIdDetailModel,"FirefighterIdDetailModel");sap.ui.core.BusyIndicator.hide();this._oDialog_DisplayDetailFfId=sap.ui.xmlfragment(this.getView().getId(),"GATE.ZGATE_FF_ASS.view.fragment.DisplayDetailFfId",this);var i=this.getView().getModel("i18n").getResourceBundle().getText("lblDetail")+s.Ffobject;this._oDialog_DisplayDetailFfId.setTitle(i);this.getView().addDependent(this._oDialog_DisplayDetailFfId);this._oDialog_DisplayDetailFfId.open()}.bind(this),error:function(e){o.show(e.message+" ("+e.statusText+")");sap.ui.core.BusyIndicator.hide()}.bind(this)})},onCloseDisplayDetailFfId:function(){if(this._oDialog_DisplayDetailFfId){this._oDialog_DisplayDetailFfId.destroy();this.getView().setBusy(false)}},onSearchFfId:function(e){sap.ui.core.BusyIndicator.show();var i=new Array;var s=new n({path:"Connector",operator:r.EQ,value1:this.getView().getModel("GlobalData").getData().System});i.push(s);var a=new n({path:"FieldValue",operator:r.EQ,value1:this.getView().byId("iFfFieldValue").getValue()});i.push(a);var l=new n({path:"FieldName",operator:r.EQ,value1:this.getView().byId("sFfSearchBy").getSelectedKey()});i.push(l);this.getOwnerComponent().getModel().read("/FirefighterIdSet",{filters:i,success:function(e){this.AvailableFfIdModel=new t(e);this.getView().setModel(this.AvailableFfIdModel,"AvailableFfIdModel");sap.ui.core.BusyIndicator.hide()}.bind(this),error:function(e){o.show(e.message+" ("+e.statusText+")");sap.ui.core.BusyIndicator.hide()}.bind(this)})},onCloseFfIdDialog:function(){if(this._oDialog_AddFfId){this._oDialog_AddFfId.destroy();this.getView().setBusy(false)}},OnSubmitAssignFfIdDialog:function(){if(this.tab_SelectedFfId===undefined){this.tab_SelectedFfId=[]}var e=this.getView().getModel("AvailableFfIdModel");if(e!==undefined){var i;for(var s=0;s<this.AvailableFfIdModel.oData.results.length;s++){if(this.AvailableFfIdModel.oData.results[s].Rank){i=false;if(this.tab_SelectedFfId.length!==0){for(var a=0;a<this.tab_SelectedFfId.length;a++){if(this.AvailableFfIdModel.oData.results[s].AppType===this.tab_SelectedFfId[a].AppType&&this.AvailableFfIdModel.oData.results[s].Ffobject===this.tab_SelectedFfId[a].Ffobject&&this.AvailableFfIdModel.oData.results[s].Connector===this.tab_SelectedFfId[a].Connector){i=true}}}if(i===false){this.tab_SelectedFfId.push(this.AvailableFfIdModel.oData.results[s])}}}this.initRiskCheckTab();this.setFfIdValidityDates();this.SelectedFfIdModel=new t(this.tab_SelectedFfId);this.getView().setModel(this.SelectedFfIdModel,"SelectedFfIdModel")}this._oDialog_AddFfId.destroy();this.getView().setBusy(false);this.FillReasonCodeList()},CheckSNOWReferenceTicket:function(){var e=false;if(this.getView().getModel("GlobalData").getData().ReferenceTicket!==""&&this.getView().getModel("GlobalData").getData().ReferenceTicket.substring(0,3)!=="INC"&&this.getView().getModel("GlobalData").getData().ReferenceTicket.substring(0,3)!=="ENH"&&this.getView().getModel("GlobalData").getData().ReferenceTicket.substring(0,3)!=="PRJ"&&this.getView().getModel("GlobalData").getData().ReferenceTicket.substring(0,3)!=="DMD"&&this.getView().getModel("GlobalData").getData().ReferenceTicket.substring(0,4)!=="RITM"){var t=this;a.error(this.getView().getModel("i18n").getResourceBundle().getText("MsgErrorSnowFormat"),{actions:[a.Action.OK],emphasizedAction:a.Action.OK,onClose:function(e){t.getView().byId("iSnowTicket").focus()}});this.getView().byId("iSnowTicket").setValueState("Error");e=true}else if(this.tab_SelectedFfId!==undefined){var i=false;for(var s=0;s<this.tab_SelectedFfId.length;s++){if(this.tab_SelectedFfId[s].Ffobject.substring(0,4)==="FFIT"){i=true}}if(this.getView().getModel("GlobalData").getData().ReferenceTicket===""&&i===true){var t=this;a.error(this.getView().getModel("i18n").getResourceBundle().getText("MsgErrorSnowEmpty"),{actions:[a.Action.OK],emphasizedAction:a.Action.OK,onClose:function(e){t.getView().byId("iSnowTicket").focus()}});this.getView().byId("iSnowTicket").setValueState("Error");e=true}else{this.getView().byId("iSnowTicket").setValueState("None")}}else{this.getView().byId("iSnowTicket").setValueState("None")}return e},onChangeHeaderDates:function(){if(this.getView().getModel("GlobalData").getData().ValDateFrom!==""){this.getView().byId("iValDateFrom").setValueState("None")}else{this.getView().byId("iValDateFrom").focus();this.getView().byId("iValDateFrom").setValueState("Error")}if(this.getView().getModel("GlobalData").getData().ValDateTo!==""){this.getView().byId("iValDateTo").setValueState("None")}else{this.getView().byId("iValDateTo").focus();this.getView().byId("iValDateTo").setValueState("Error")}if(this.getView().byId("iValDateFrom").getProperty("dateValue")>this.getView().byId("iValDateTo").getProperty("dateValue")){this.getView().byId("iValDateFrom").setValueState("Error");this.getView().byId("iValDateTo").setValueState("Error");var e=this;a.warning(this.getView().getModel("i18n").getResourceBundle().getText("MsgDateFromGTValidTo"),{actions:[a.Action.OK],emphasizedAction:a.Action.OK,onClose:function(t){e.getView().byId("iValDateFrom").focus()}})}this.setFfIdValidityDates()},setFfIdValidityDates:function(){var e=new Date(this.getView().byId("iValDateFrom").getProperty("dateValue"));if(this.tab_SelectedFfId!==undefined){for(var i=0;i<this.tab_SelectedFfId.length;i++){this.tab_SelectedFfId[i].ValidFrom=e;this.tab_SelectedFfId[i].ValidTo=this.getView().byId("iValDateTo").getProperty("dateValue")}this.SelectedFfIdModel=new t(this.tab_SelectedFfId);this.getView().setModel(this.SelectedFfIdModel,"SelectedFfIdModel")}},FfIdConfig:{initialRank:0,defaultRank:1024,rankAlgorithm:{Before:function(e){return e+1024},Between:function(e,t){return(e+t)/2},After:function(e){return e/2}}},onFfIdDragStart:function(e){var t=e.getParameter("target");var i=e.getParameter("dragSession");i.setComplexData("draggedRowContext",t.getBindingContext("AvailableFfIdModel"))},onFfIdDropTable1:function(e){var t=e.getParameter("dragSession");var i=t.getComplexData("draggedRowContext");if(!i){return}this.AvailableFfIdModel.setProperty("Rank",this.FfIdConfig.initialRank,i);this.AvailableFfIdModel.refresh(true)},FfIdMoveToTable1:function(){var e=this.getView().byId("FfIdTable2");var t=e.getSelectedIndices();if(t.length==0){o.show(this.getView().getModel("i18n").getResourceBundle().getText("MsgSelectARow"));return}else if(t.length==1){this.getSelectedRowContext("FfIdTable2",function(e,t,i){this.AvailableFfIdModel.setProperty("Rank",this.FfIdConfig.initialRank,e);this.AvailableFfIdModel.refresh(true);var s=i.getContextByIndex(t+1);if(!s){i.setSelectedIndex(t-1)}})}else if(t.length>1){var i,s,a;for(var n=t.length;n>=0;n--){s=t[n];this.AvailableFfIdModel.setProperty("Rank",this.FfIdConfig.initialRank,e.getContextByIndex(t[n]));this.AvailableFfIdModel.refresh(true)}}this.getView().byId("FfIdTable1").clearSelection();this.getView().byId("FfIdTable2").clearSelection()},onFfIdDropTable2:function(e){var t=e.getParameter("dragSession");var i=t.getComplexData("draggedRowContext");if(!i){return}var a=this.FfIdConfig;var o=a.defaultRank;var n=e.getParameter("droppedControl");if(n&&n instanceof s){var r=e.getParameter("dropPosition");var l=n.getBindingContext("AvailableFfIdModel");var d=l.getProperty("Rank");var g=n.getIndex();var h=n.getParent();var c=g+(r==="After"?1:-1);var u=h.getContextByIndex(c);if(!u){o=a.rankAlgorithm[r](d)}else{o=a.rankAlgorithm.Between(d,u.getProperty("Rank"))}}this.AvailableFfIdModel.setProperty("Rank",o,i);this.AvailableFfIdModel.refresh(true)},FfIdMoveToTable2:function(){var e=this.getView().byId("FfIdTable1");var t=this.getView().byId("FfIdTable2");var i=e.getSelectedIndices();var s=this.FfIdConfig.defaultRank;var a=t.getContextByIndex(0);if(i.length==0){o.show(this.getView().getModel("i18n").getResourceBundle().getText("MsgSelectARow"));return}else if(i.length==1){this.getSelectedRowContext("FfIdTable1",function(e){if(a){s=this.FfIdConfig.rankAlgorithm.Before(a.getProperty("Rank"))}this.AvailableFfIdModel.setProperty("Rank",s,e);this.AvailableFfIdModel.refresh(true)})}else if(i.length>1){var n;for(var r=i.length;r>=0;r--){n=e.getContextByIndex(i[r]);a=t.getContextByIndex(0);if(a){s=this.FfIdConfig.rankAlgorithm.Before(a.getProperty("Rank"))}this.AvailableFfIdModel.setProperty("Rank",s,n);this.AvailableFfIdModel.refresh(true)}}this.getView().byId("FfIdTable1").clearSelection();this.getView().byId("FfIdTable2").clearSelection()},initRiskCheckTab:function(){var e=this.getView().getModel("reportSummaryUser");if(e!==undefined){e.setData(null)}this.getView().byId("tRiskCheck").setNoDataText(this.getView().getModel("i18n").getResourceBundle().getText("lblRiskAnalysisNotStarted"))},launchSoDReport:function(e){if(this.tab_SelectedUsers===undefined||this.tab_SelectedUsers.length===0){var t=this;this.getView().byId("iconTabBarNoIcons").setSelectedKey("1");a.warning(this.getView().getModel("i18n").getResourceBundle().getText("MsgErrorAddUsers"),{actions:[a.Action.OK],emphasizedAction:a.Action.OK,onClose:function(e){t.onAddAddUsersDialog()}})}else if(this.tab_SelectedFfId===undefined||this.tab_SelectedFfId.length===0){var t=this;this.getView().byId("iconTabBarNoIcons").setSelectedKey("2");a.warning(this.getView().getModel("i18n").getResourceBundle().getText("MsgErrorAddFfId"),{actions:[a.Action.OK],emphasizedAction:a.Action.OK,onClose:function(e){t.onAddFfIdToAssignDialog()}})}else{this.getView().setBusy(true);var i=new Array;for(var s=0;s<this.tab_SelectedUsers.length;s++){var l=this.tab_SelectedUsers[s].UserId+";"+this.tab_SelectedUsers[s].Connector;var d=new n({path:"UserIds",operator:r.EQ,value1:l});i.push(d)}for(var s=0;s<this.tab_SelectedFfId.length;s++){var l=this.tab_SelectedFfId[s].Ffobject+";"+this.tab_SelectedFfId[s].Connector;var d=new n({path:"FfIds",operator:r.EQ,value1:l});i.push(d)}this.getOwnerComponent().getModel().read("/reportSODUserSet",{filters:i,success:function(e){var t;for(var i=0;i<e.results.length;i++){if(t){t=t+";"+e.results[i].ReportId}else{t=e.results[i].ReportId}}this.getReportSummary(t)}.bind(this),error:function(e){this.initRiskCheckTab();o.show(e.message+" ("+e.statusText+")");this.getView().setBusy(false)}.bind(this)})}},getReportSummary:function(e){this.getOwnerComponent().getModel().read("/reportSumUserSet",{urlParameters:{search:e},success:function(e,i){if(e.results.length===0){}else{var s=new t(e);this.getView().setModel(s,"reportSummaryUser");this.getView().getModel("reportSummaryUser").refresh(true)}this.getView().setBusy(false)}.bind(this),error:function(e){this.getView().setBusy(false);o.show(e.message+" ("+e.statusText+")");this.getView().setBusy(false)}.bind(this)});this.getOwnerComponent().getModel().read("/ReportDetUserSet",{urlParameters:{search:e},success:function(e,i){var s=new t(e);s.setSizeLimit(99999999);this.getView().setModel(s,"reportDetailUser");this.getView().byId("tRiskCheck").setNoDataText(this.getView().getModel("i18n").getResourceBundle().getText("MsgRiskFinishedSucc"));this.getView().getModel("reportDetailUser").refresh(true);this.getView().setBusy(false)}.bind(this),error:function(e){this.getView().setBusy(false);o.show(e.message+" ("+e.statusText+")")}.bind(this)})},navToReportDetailUser:function(e){var i=e.getSource().getBindingContext("reportSummaryUser").getObject();var s=this.groupRiskByFunction(this.getView().getModel("reportDetailUser").getData().results,i.Riskid);i.ReportType="01";var a=new t(this.getView().getModel("reportDetailUser").getData().results);this.getOwnerComponent().setModel(a,"AllRisks");var o=new t(i);this.getOwnerComponent().setModel(o,"RiskHeader");var n=new t(s);n.setSizeLimit(99999999);this.getOwnerComponent().setModel(n,"RDetails");this.getView().byId("myFCL").setLayout("TwoColumnsMidExpanded")},groupRiskByFunction:function(e,i){var s=e.filter(function(e){return e.Riskid==i}.bind(this));var a={};var o=s;var n=[];for(var r,l=0;r=o[l++];){var d=r.Comprole;if(!(d in a)&&d.indexOf("[BR]")>-1){a[d]=1;n.push(d)}}var g=new t(n);this.getOwnerComponent().setModel(g,"BRoles");const h=Object.entries(s.reduce(function(e,t){e[t.Functid]=e[t.Functid]||[];e[t.Functid].push(t);return e},{})).map(function(e){return{func:e[0],data:e[1]}});for(var l=0;l<h.length;l++){h[l].transactions=Object.entries(h[l].data.reduce(function(e,t){e[t.Action]=e[t.Action]||[];e[t.Action].push(t);return e},{})).map(function(e){for(var t=0;t<e[1].length;t++){var i=e[1].filter(function(e){return e.Lastexecutedon!=="0"&&e.Lastexecutedon!=="0 "});var s=e[1].filter(function(e){return e.Comprole.indexOf("[BR]")>-1});if(s.length>0){s=s[0].Comprole}else{s=""}var a;if(i.length>0&&i[0].Lastexecutedon.length>3){a=i[0].Lastexecutedon;a=a.substring(8,10)+":"+a.substring(10,12)+":"+a.substring(12,14)+" "+a.substring(6,8)+"/"+a.substring(4,6)+"/"+a.substring(0,4)}else{a=0}if(e[1][t].Comprole.indexOf("[BR]")>-1){return{tcode:e[0],data:e[1],brole:e[1][t].Comprole,srole:e[1][t].Role,Lastexecutedon:a}}else{return{tcode:e[0],data:e[1],brole:s,srole:e[1][t].Role,Lastexecutedon:a}}}});delete h[l].data}return h},handleFullScreen:function(){this.getView().byId("myFCL").setLayout("MidColumnFullScreen")},handleExitFullScreen:function(){this.getView().byId("myFCL").setLayout("TwoColumnsMidExpanded")},handleClose:function(e){var t=this.getOwnerComponent().getRouter().getHashChanger().getHash();this.getView().byId("myFCL").setLayout("OneColumn")},onRowShiftAction:function(e){var t=e.getSource(),i=t.getParent();if(t.getSrc()==="sap-icon://expand"){t.setSrc("sap-icon://collapse");i.getCells()[8].setVisible(true)}else{t.setSrc("sap-icon://expand");i.getCells()[8].setVisible(false)}},onBRliveChange:function(e){var t=e.getSource().getParent().getParent().getItems();var i=[],s=e.getParameter("newValue");if(s&&s.length>0){var a=[];a.push(new n("srole",r.Contains,s));a.push(new n("brole",r.Contains,s));for(var o=0;o<t.length;o++){t[o].getContent()[0].getBinding("items").filter(new n(a,false))}}},navToaRiskCard:function(e){var i=e.getSource().getBindingContext("reportSummaryUser").getObject();var s="/RiskCardSet(Riskid='"+i.Riskid+"',Bproc='"+i.BusinessProcess+"')";this.getView().setBusy(true);this.getOwnerComponent().getModel().read(s,{success:function(e){var i=new t(e);this.getView().setModel(i,"Risk");this.openRiskCardDialog();this.getView().setBusy(false)}.bind(this),error:function(e){this.getView().setBusy(false);a.information(this.getView().getModel("i18n").getResourceBundle().getText("MsgRiskCardNotFound"),{actions:[a.Action.OK],emphasizedAction:a.Action.OK})}.bind(this)});this.getCardRiskDocs(i.Riskid,i.BusinessProcess);this.getCardRiskFunctions(i.Riskid)},getCardRiskFunctions:function(e){this.getOwnerComponent().getModel().read("/FunctionsSet",{urlParameters:{search:e,$expand:"FunctionsToGetActions"},success:function(e,i){var s=new t(e.results);this.getView().setModel(s,"RFunctions")}.bind(this),error:function(e){o.show(e.message+" ("+e.statusText+")");this.getView().setBusy(false)}.bind(this)})},getCardRiskDocs:function(e,i){var s=[];s.push(new n("Bproc",r.EQ,i));s.push(new n("Riskid",r.EQ,e));this.getOwnerComponent().getModel().read("/SharepointSet",{filters:s,success:function(e,i){var s=new t(e.results);this.getView().setModel(s,"RDocuments")}.bind(this),error:function(e){o.show(e.message+" ("+e.statusText+")");this.getView().setBusy(false)}.bind(this)})},openRiskCardDialog:function(){if(!this.oDialogRiskCard){var e=this.getView();this.oDialogRiskCard=e.byId("riskCard");this.oDialogRiskCard=sap.ui.xmlfragment(e.getId(),"GATE.ZGATE_FF_ASS.view.fragment.riskCard",this);this.getView().addDependent(this.oDialogRiskCard)}this.oDialogRiskCard.open()},handleCloseRiskCardDialog:function(e){this.oDialogRiskCard.close()},onDisplayQuickViewReasonCode:function(e){this.openQuickView(e,this.getView().getModel("i18n").getResourceBundle().getText("MsgNoReasonCode"))},openQuickView:function(e,t){var s=e.getSource(),a=this.getView();this.getView().getModel("GlobalData").setProperty("/MsgQuickView",t);if(!this._pQuickView){this._pQuickView=i.load({id:a.getId(),name:"GATE.ZGATE_FF_ASS.view.fragment.QuickView",controller:this}).then(function(e){a.addDependent(e);return e})}this._pQuickView.then(function(e){e.openBy(s)})},onAddAttachmentsDialog:function(){this._oDialog_Attachments=sap.ui.xmlfragment(this.getView().getId(),"GATE.ZGATE_FF_ASS.view.fragment.Attachments",this);this.getView().addDependent(this._oDialog_Attachments);this._oDialog_Attachments.open()},onCloseAttachments:function(){if(this._oDialog_Attachments){this._oDialog_Attachments.destroy();this.getView().setBusy(false)}},onSelectAttachmentType:function(){var e=this.getView().byId("rbgAttachmentType").getSelectedButton().getProperty("text");if(e.substring(0,1)==="F"){this.getView().getModel("GlobalData").setProperty("/AttachmentType","L")}else{this.getView().getModel("GlobalData").setProperty("/AttachmentType","F")}},onUpload:function(){var e=this;if(this.getView().getModel("GlobalData").getData().AttachmentType==="L"&&this.getView().getModel("GlobalData").getData().AttachmentLink===""){a.warning(this.getView().getModel("i18n").getResourceBundle().getText("MsgErrorSelectALink"),{actions:[a.Action.OK],emphasizedAction:a.Action.OK,onClose:function(t){e.getView().byId("iAttachmentLink").focus()}})}else if(this.getView().getModel("GlobalData").getData().AttachmentType==="F"&&this.getView().byId("fileUploader").getProperty("value")!==undefined&&this.getView().byId("fileUploader").getProperty("value")===""){a.warning(this.getView().getModel("i18n").getResourceBundle().getText("MsgErrorSelectAFile"),{actions:[a.Action.OK],emphasizedAction:a.Action.OK,onClose:function(e){}})}else{if(this.tab_SelectedAttachments===undefined){this.tab_SelectedAttachments=[]}if(this.getView().getModel("GlobalData").getData().AttachmentType==="F"){var i=this.getView().byId("fileUploader");var s=i.getFocusDomRef();var o=s.files[0];var n=this.getView().getModel("GlobalData").getData().AttachmentTitle;this.file=o;var r=new FileReader;r.onload=function(t){var i={Icon:"sap-icon://documents",Title:n!==""?n:e.file.name,Url:"",Name:e.file.name,Type:e.file.type,Size:e.file.size,Content:t.currentTarget.result};e.tab_SelectedAttachments.push(i);e.getView().getModel("SelectedAttachmentsModel").refresh(true)};r.readAsDataURL(o)}else{var l={Icon:"sap-icon://chain-link",Title:this.getView().getModel("GlobalData").getData().AttachmentTitle!==""?this.getView().getModel("GlobalData").getData().AttachmentTitle:this.getView().getModel("GlobalData").getData().AttachmentLink,Url:this.getView().getModel("GlobalData").getData().AttachmentLink,Name:this.getView().getModel("GlobalData").getData().AttachmentLink,Type:"URL Link",Size:"-",Content:""};this.tab_SelectedAttachments.push(l)}this.SelectedAttachmentsModel=new t(this.tab_SelectedAttachments);this.getView().setModel(this.SelectedAttachmentsModel,"SelectedAttachmentsModel");this.getView().getModel("GlobalData").setProperty("/AttachmentTitle","");this.getView().getModel("GlobalData").setProperty("/AttachmentType","F");this.getView().getModel("GlobalData").setProperty("/AttachmentLink","");this.getView().getModel("GlobalData").setProperty("/AttachmentFileData","");this._oDialog_Attachments.destroy();this.getView().setBusy(false)}},onDeleteAttachment:function(e){var i=e.getSource().getParent().getBindingContextPath();var s=this.getView().getModel("SelectedAttachmentsModel").getObject(i);for(var a in this.tab_SelectedAttachments){if(s.Name===this.tab_SelectedAttachments[a].Name&&s.Title===this.tab_SelectedAttachments[a].Title&&s.Type===this.tab_SelectedAttachments[a].Type&&s.Size===this.tab_SelectedAttachments[a].Size){this.tab_SelectedAttachments.splice(a,1)}}this.SelectedAttachmentsModel=new t(this.tab_SelectedAttachments);this.getView().setModel(this.SelectedAttachmentsModel,"SelectedAttachmentsModel")},onSubmitRequest:function(){var e=this.CheckSNOWReferenceTicket();var t=this.checkMandatoryFields();if(e===false&&t===""){if(this.getView().getModel("GlobalData").getData().ValDateFrom===""){this.getView().byId("iValDateFrom").setValueState("Error");var i=this;a.warning(this.getView().getModel("i18n").getResourceBundle().getText("MsgErrorValidityStartDate"),{actions:[a.Action.OK],emphasizedAction:a.Action.OK,onClose:function(e){i.getView().byId("iValDateFrom").focus()}})}else if(this.getView().getModel("GlobalData").getData().ValDateTo===""){this.getView().byId("iValDateTo").setValueState("Error");var i=this;a.warning(this.getView().getModel("i18n").getResourceBundle().getText("MsgErrorValidityEndDate"),{actions:[a.Action.OK],emphasizedAction:a.Action.OK,onClose:function(e){i.getView().byId("iValDateTo").focus()}})}else if(this.getView().getModel("GlobalData").getData().ValDateFrom>this.getView().getModel("GlobalData").getData().ValDateTo){this.getView().byId("iValDateFrom").setValueState("Error");this.getView().byId("iValDateTo").setValueState("Error");var i=this;a.warning(this.getView().getModel("i18n").getResourceBundle().getText("MsgDateFromGTValidTo"),{actions:[a.Action.OK],emphasizedAction:a.Action.OK,onClose:function(e){i.getView().byId("iValDateFrom").focus()}})}else if(this.tab_SelectedUsers===undefined||this.tab_SelectedUsers.length===0){var i=this;this.getView().byId("iconTabBarNoIcons").setSelectedKey("1");a.warning(this.getView().getModel("i18n").getResourceBundle().getText("MsgErrorAddUsers"),{actions:[a.Action.OK],emphasizedAction:a.Action.OK,onClose:function(e){i.onAddAddUsersDialog()}})}else if(this.tab_SelectedFfId===undefined||this.tab_SelectedFfId.length===0){var i=this;this.getView().byId("iconTabBarNoIcons").setSelectedKey("2");a.warning(this.getView().getModel("i18n").getResourceBundle().getText("MsgErrorAddFfId"),{actions:[a.Action.OK],emphasizedAction:a.Action.OK,onClose:function(e){i.onAddFfIdToAssignDialog()}})}else if(this.getView().getModel("GlobalData").getData().ReasonCode===""){var i=this;this.getView().byId("iconTabBarNoIcons").setSelectedKey("4");a.warning(this.getView().getModel("i18n").getResourceBundle().getText("MsgErrorMissingReasonCode"),{actions:[a.Action.OK],emphasizedAction:a.Action.OK,onClose:function(e){}})}else{var i=this;a.confirm(this.getView().getModel("i18n").getResourceBundle().getText("MsgConfirmSubmit"),{actions:[a.Action.YES,a.Action.CANCEL],emphasizedAction:a.Action.YES,onClose:function(e){if(e==="YES"){i.CreateFfAssignRequest()}}})}}},CreateFfAssignRequest:function(){this.getView().setBusy(true);var e={};e.RequestDataToRequestUsersNav=[];e.Reqtype="006";e.Zpi7LicenseDataType="91";e.ZrequestName="";e.ZreferenceTicket=this.getView().getModel("GlobalData").getData().ReferenceTicket;for(var t=0;t<this.tab_SelectedUsers.length;t++){var i={};i.UserId=this.tab_SelectedUsers[t].UserId;i.Connector=this.tab_SelectedUsers[t].Connector;i.UserType="A";e.RequestDataToRequestUsersNav.push(i)}for(var t=0;t<this.tab_SelectedFfId.length;t++){var s=this.dateFormatYYYYMMDD.format(this.getView().byId("iValDateFrom").getProperty("dateValue"));var n=this.dateFormatYYYYMMDD.format(this.getView().byId("iValDateTo").getProperty("dateValue"));var r={};r.UserId=this.tab_SelectedFfId[t].Ffobject;r.Connector=this.tab_SelectedFfId[t].Connector;r.UserType="S";r.ValidFrom=s;r.ValidTo=n;e.RequestDataToRequestUsersNav.push(r)}this.getOwnerComponent().getModel().create("/RequestDataSet",e,{success:function(e,t){var i=e.Reqno;if(i){this.onSaveCommentAndAttachments(i);this.getView().setBusy(false);a.success(this.getView().getModel("i18n").getResourceBundle().getText("MsgRequestsubSuccess")+" "+i,{actions:[a.Action.OK],emphasizedAction:a.Action.OK,onClose:function(e){if(e==="OK"){location.reload()}}})}else{debugger;var s=JSON.parse(t.headers["sap-message"]).message;this.getView().setBusy(false);a.error(s,{actions:[a.Action.OK],emphasizedAction:a.Action.OK,onClose:function(e){if(e==="OK"){}}})}}.bind(this),error:function(e){o.show(e.message+" ("+e.statusText+")");this.getView().setBusy(false)}.bind(this)})},onSaveCommentAndAttachments:function(e){this.getView().setBusy(true);var t={};t.RequestNoToAttachmentsNav=[];t.Reqno=e;t.BusJustif=this.getView().getModel("GlobalData").getData().Comments;t.SodManaged="";t.Other=this.getView().getModel("GlobalData").getData().ReasonCode;if(this.tab_SelectedAttachments!==undefined&&this.tab_SelectedAttachments.length!==0){for(var i=0;i<this.tab_SelectedAttachments.length;i++){var s={};s.Reqno=e;s.FileName=this.tab_SelectedAttachments[i].Name;s.Title=this.tab_SelectedAttachments[i].Title;s.FileType=this.tab_SelectedAttachments[i].Type;s.FileSize=this.tab_SelectedAttachments[i].Size.toString();s.FileContent=this.tab_SelectedAttachments[i].Content;s.Url=this.tab_SelectedAttachments[i].Url;t.RequestNoToAttachmentsNav.push(s)}}this.getOwnerComponent().getModel().create("/RequestNoSet",t,{success:function(e,t){this.getView().setBusy(false)}.bind(this),error:function(e){this.getView().setBusy(false)}.bind(this)})}})});